{% extends 'Template/StandardTemplate.html.twig' %}
{% import 'Template/Macros/breadcrumb.html.twig' as breadcrumb %}

{% block title %}Statistiken aus {{ city.city }}{% endblock %}

{% block breadcrumb %}
    {{ breadcrumb.item('Städteliste', path('caldera_criticalmass_city_list')) }}
    {{ breadcrumb.item(city.city, object_path(city)) }}
    {{ breadcrumb.active('Statistiken') }}
{% endblock %}

{% block content %}
    <div class="container">
        {{ include('Flash/_flash.html.twig') }}

        {{ include('City/Includes/_tabs.html.twig', { tab: 'statistic' }) }}

        {# Header Card #}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h4 class="mb-2">
                            <i class="far fa-chart-bar text-primary me-2"></i>Stadt-Statistiken von {{ city.city }}
                        </h4>
                        <p class="text-muted mb-0">
                            Wie viele, wie lange, wohin? Diese Seite bereitet die statistischen Daten auf, die von Teilnehmern
                            der Critical Mass in {{ city.city }} nach einer Tour eingearbeitet worden sind.
                        </p>
                    </div>
                    <a href="{{ object_path(city, 'caldera_criticalmass_city_missingstats') }}" class="btn btn-outline-primary btn-sm">
                        <i class="far fa-list-alt me-1"></i>Fehlende Statistiken
                    </a>
                </div>
            </div>
        </div>

        {# Chart Card #}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="card-title mb-0">
                    <i class="far fa-users text-primary me-2"></i>Teilnehmerzahl
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Bei der angezeigten Teilnehmerzahl handelt es sich um den Durchschnitt der Werte, die von den
                    Teilnehmern geschätzt wurden.
                </p>

                <div data-controller="statistic-city-chart">
                    <canvas id="chart" style="width: 100%; height: 400px;" data-statistic-city-chart-target="canvas"></canvas>

                    {% for ride in rides %}
                        <span class="d-none" data-statistic-city-chart-target="rideData"
                              data-ride-datetime="{{ ride.dateTime|date('Y-m-d') }}"
                              data-estimated-participants="{{ ride.estimatedParticipants|default(0) }}"
                              data-estimated-duration="{{ ride.estimatedDuration|default(0) }}"
                              data-estimated-distance="{{ ride.estimatedDistance|default(0) }}"></span>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# Table Card #}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-bottom">
                <h5 class="card-title mb-0">
                    <i class="far fa-table text-primary me-2"></i>Tabellarischer Vergleich
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Gibt es einen Zusammenhang zwischen dem Wetter und den Teilnehmerzahlen?
                </p>

                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Datum</th>
                                <th class="d-none d-md-table-cell">Temperatur</th>
                                <th class="d-none d-lg-table-cell">Niederschlag</th>
                                <th class="d-none d-lg-table-cell">Windgeschwindigkeit</th>
                                <th>Teilnehmer</th>
                                <th class="d-none d-md-table-cell">Strecke</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ride in rides %}
                                {% set weather = ride.weathers.first %}
                                {% if weather %}
                                    <tr>
                                        <td>
                                            <a href="{{ object_path(ride) }}" class="text-decoration-none">
                                                {{ ride.dateTime|date('d.m.Y') }}
                                            </a>
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            <i class="far fa-thermometer-half text-warning me-1"></i>
                                            {{ weather.temperatureEvening|number_format(1) }} °C
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <i class="far fa-tint text-info me-1"></i>
                                            {{ weather.precipitation|number_format(1) }} mm
                                        </td>
                                        <td class="d-none d-lg-table-cell">
                                            <i class="far fa-wind text-secondary me-1"></i>
                                            {{ weather.windSpeed|number_format(1) }} m/s
                                        </td>
                                        <td>
                                            {% if ride.estimatedParticipants %}
                                                <span class="badge bg-primary">{{ ride.estimatedParticipants|number_format(0) }}</span>
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            {% if ride.estimatedDistance %}
                                                {{ ride.estimatedDistance|number_format(1) }} km
                                            {% else %}
                                                <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
