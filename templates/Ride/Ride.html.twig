{% if dateTime > ride.getDateTime() %}
    {% set pastRide = true %}
{% else %}
    {% set pastRide = false %}
{% endif %}

{# Hero Section mit Karte und wichtigsten Informationen #}
<div class="card mb-4 border-0 shadow-sm overflow-hidden">
    <div class="row g-0">
        {# Karte links (auf größeren Bildschirmen) #}
        <div class="col-lg-7">
            <div
                data-controller="map--ride-map"
                class="h-100"
                style="min-height: 300px;"
                data-map--ride-map-city-slug-value="{{ ride.city.mainSlugString }}"
                data-map--ride-map-ride-identifier-value="{{ ride.slug|default(ride.dateTime|date('Y-m-d')) }}"
                data-map--ride-map-latitude-value="{{ ride.latitude }}"
                data-map--ride-map-longitude-value="{{ ride.longitude }}"
            ></div>
        </div>

        {# Tour-Infos rechts #}
        <div class="col-lg-5">
            <div class="card-body d-flex flex-column h-100">
                {# Header mit Titel und Participation #}
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1 pe-3">
                        <h1 class="h3 mb-1" itemprop="name">{{ ride.title }}</h1>
                        <a href="{{ object_path(ride.city) }}" class="text-muted text-decoration-none">
                            <i class="far fa-map-marker-alt me-1"></i>{{ ride.city.city }}
                        </a>
                    </div>
                    {% include('Ride/Includes/_participation.html.twig') with { 'pastRide': pastRide, 'participation': participation } %}
                </div>

                {# Wichtige Details als Icons/Badges #}
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="far fa-calendar-alt text-primary fa-lg"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Datum</small>
                                <strong itemprop="startDate" content="{{ ride.dateTime|date('Y-m-dTH:i') }}">
                                    {{ ride.dateTime|date('D, d.m.Y', ride.city.timezone) }}
                                </strong>
                                <meta itemprop="endDate" content="{{ date_time_add(ride.dateTime, 'PT2H')|date('Y-m-dTH:i') }}" />
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center">
                            <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="far fa-clock text-success fa-lg"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Uhrzeit</small>
                                {% if ride.dateTime %}
                                    <strong>{{ ride.dateTime|date('H:i', ride.city.timezone) }} Uhr</strong>
                                {% else %}
                                    <span class="text-muted">noch nicht bekannt</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center" itemprop="location" itemscope itemtype="http://schema.org/Place">
                            <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                                <i class="far fa-map-pin text-warning fa-lg"></i>
                            </div>
                            <div class="flex-grow-1">
                                <small class="text-muted d-block">Treffpunkt</small>
                                {% if ride.location and ride.latitude and ride.longitude %}
                                    {% if location %}
                                        <strong itemprop="name">
                                            <a href="{{ object_path(ride, 'caldera_criticalmass_location_ride') }}" class="text-decoration-none">
                                                {{ ride.location }}
                                            </a>
                                        </strong>
                                    {% else %}
                                        <strong itemprop="name">{{ ride.location }}</strong>
                                    {% endif %}
                                    <div itemprop="geo" itemscope itemtype="http://schema.org/GeoCoordinates">
                                        <meta itemprop="latitude" content="{{ ride.latitude }}" />
                                        <meta itemprop="longitude" content="{{ ride.longitude }}" />
                                    </div>
                                {% else %}
                                    {% if app.user %}
                                        <a href="{{ object_path(ride, 'caldera_criticalmass_ride_edit') }}" class="text-muted">
                                            <i class="far fa-edit me-1"></i>noch nicht bekannt
                                        </a>
                                    {% else %}
                                        <a href="#" class="text-muted"
                                            data-controller="hint-modal"
                                            data-modal-hint-title="{{ 'hint_modal.ride.location_edit_link.title'|trans }}"
                                            data-modal-hint-text="{{ 'hint_modal.ride.location_edit_link.text'|trans({'%city%': ride.city.city, '%dateTime%': ride.dateTime|date('d.m.Y')}) }}"
                                            data-modal-hint-size="md">
                                            noch nicht bekannt
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {# Aktions-Buttons #}
                <div class="mt-auto">
                    <div class="d-grid gap-2 d-md-flex">
                        {% if ride.dateTime %}
                            <a href="{{ object_path(ride, 'caldera_criticalmass_ride_ical') }}" class="btn btn-outline-success flex-grow-1">
                                <i class="far fa-calendar-plus me-1"></i>
                                Im Kalender speichern
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Tabs für Details, Mini-Masses, Kommentare etc. #}
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
        <ul class="nav nav-tabs card-header-tabs" id="rideTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">
                    <i class="far fa-flag me-1"></i>
                    Details
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="minimass-tab" data-bs-toggle="tab" data-bs-target="#minimass" type="button" role="tab" aria-controls="minimass" aria-selected="false">
                    <i class="far fa-map-marker me-1"></i>
                    Mini-Masses
                    <span class="badge bg-secondary ms-1">{{ ride.getSubrides|length }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab" aria-controls="comments" aria-selected="false">
                    <i class="far fa-comments me-1"></i>
                    Kommentare
                    <span class="badge bg-secondary ms-1">{{ ride.getPosts|length }}</span>
                </button>
            </li>
            {% if pastRide and ride.enabled %}
                {% if feature('photos') %}
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" href="{{ object_path(ride, 'caldera_criticalmass_photo_ride_list') }}">
                            <i class="far fa-images me-1"></i>
                            Galerie
                            <span class="badge bg-secondary ms-1">{{ photos|length }}</span>
                        </a>
                    </li>
                {% endif %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tracks-tab" data-bs-toggle="tab" data-bs-target="#tracks" type="button" role="tab" aria-controls="tracks" aria-selected="false">
                        <i class="far fa-route me-1"></i>
                        Tracks
                        <span class="badge bg-secondary ms-1">{{ tracks|length }}</span>
                    </button>
                </li>
            {% endif %}
        </ul>
    </div>

    <div class="card-body">
        <div class="tab-content">
            {{ render(controller('App\\Controller\\Ride\\RideTabsController::renderDetailsTabAction', { 'ride': ride } )) }}
            {{ render(controller('App\\Controller\\Ride\\RideTabsController::renderSubridesTabAction', { 'ride': ride } )) }}
            {{ render(controller('App\\Controller\\Ride\\RideTabsController::renderPostsTabAction', { 'ride': ride } )) }}

            {% if pastRide and ride.enabled %}
                {{ render(controller('App\\Controller\\Ride\\RideTabsController::renderTracksTabAction', { 'ride': ride } )) }}
            {% endif %}
        </div>
    </div>
</div>
